<script>
(function() {
  // Wait until DOM is fully loaded
  document.addEventListener("DOMContentLoaded", function() {
    // Create toggle button
    const toggleBtn = document.createElement("button");
    toggleBtn.id = "chatbot-toggle";
    toggleBtn.innerText = "💬";
    Object.assign(toggleBtn.style, {
      position: "fixed",
      bottom: "20px",
      right: "20px",
      backgroundColor: "#0078d4",
      color: "white",
      border: "none",
      borderRadius: "50%",
      width: "60px",
      height: "60px",
      fontSize: "28px",
      cursor: "pointer",
      zIndex: "999999"
    });

    // Create chatbot container
    const chatContainer = document.createElement("div");
    chatContainer.id = "chatbot-container";
    Object.assign(chatContainer.style, {
      display: "none",
      flexDirection: "column",
      position: "fixed",
      bottom: "90px",
      right: "20px",
      width: "320px",
      height: "400px",
      backgroundColor: "white",
      border: "1px solid #ccc",
      borderRadius: "10px",
      boxShadow: "0 2px 10px rgba(0,0,0,0.2)",
      zIndex: "999999"
    });

    // Chatbox + input controls
    chatContainer.innerHTML = `
      <div id="chatbox" style="flex: 1; padding: 10px; overflow-y: auto; background-color: #f9f9f9; white-space: pre-wrap;"></div>
      <div style="display: flex; align-items: center; border-top: 1px solid #ddd; padding: 5px;">
        <input type="text" id="userInput" placeholder="Type your message..." style="width: 70%; padding: 0.5rem; margin: 5px;" />
        <button id="sendBtn" style="padding: 0.5rem; margin: 5px;">Send</button>
      </div>
    `;

    document.body.appendChild(toggleBtn);
    document.body.appendChild(chatContainer);

    // Toggle chat visibility
    toggleBtn.addEventListener("click", () => {
      chatContainer.style.display = (chatContainer.style.display === "none" ? "flex" : "none");
    });

    // Chat logic
    function appendMessage(sender, message) {
      const chatbox = document.getElementById("chatbox");
      chatbox.innerHTML += `${sender}: ${message}\n`;
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    document.getElementById("sendBtn").addEventListener("click", async () => {
      const input = document.getElementById("userInput");
      const message = input.value.trim();
      if (!message) return;
      appendMessage("You", message);
      input.value = "";

      try {
        const res = await fetch("https://gpt-chatbot-server-9g2e.onrender.com/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });

        const data = await res.json();
        if (data.reply) {
          appendMessage("Bot", data.reply);
        } else {
          appendMessage("Bot", "⚠️ Error: " + (data.error || "Unknown error"));
        }
      } catch (err) {
        appendMessage("Bot", "⚠️ Network error");
      }
    });

    // Enter key support
    document.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        const input = document.getElementById("userInput");
        if (document.activeElement === input) {
          document.getElementById("sendBtn").click();
        }
      }
    });
  });
})();
</script>
